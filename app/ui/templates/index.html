<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Layered Chat</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <main class="page">
      <header class="header">
        <h1>Layered Chat</h1>
        <p>FastAPI + Jinja2 / S3 Session + Feedback</p>
      </header>

      <section class="chat">
        <div id="messages" class="messages">
          {% for m in session.messages %}
            <div class="message {{ m.role }}">
              <div class="role">{{ m.role }}</div>
              <div class="content">{{ m.content }}</div>
            </div>
          {% endfor %}
        </div>

        <form id="chat-form" class="chat-form">
          <input id="chat-input" name="message" placeholder="Say something..." autocomplete="off" required />
          <button type="submit">Send</button>
        </form>
      </section>

      <section class="feedback">
        <h2>Feedback</h2>
        <form id="feedback-form">
          <label>
            Rating
            <select name="rating" required>
              <option value="5">5</option>
              <option value="4">4</option>
              <option value="3">3</option>
              <option value="2">2</option>
              <option value="1">1</option>
            </select>
          </label>
          <label>
            Comment
            <input name="comment" placeholder="Optional" />
          </label>
          <button type="submit">Submit</button>
        </form>
        <div id="feedback-status" class="status"></div>
      </section>
    </main>

    <script>
      const messagesEl = document.getElementById("messages");
      const chatForm = document.getElementById("chat-form");
      const chatInput = document.getElementById("chat-input");
      const feedbackForm = document.getElementById("feedback-form");
      const feedbackStatus = document.getElementById("feedback-status");

      const renderMessages = (messages) => {
        messagesEl.innerHTML = "";
        for (const m of messages) {
          const wrapper = document.createElement("div");
          wrapper.className = `message ${m.role}`;
          wrapper.innerHTML = `<div class=\"role\">${m.role}</div><div class=\"content\">${m.content}</div>`;
          messagesEl.appendChild(wrapper);
        }
        messagesEl.scrollTop = messagesEl.scrollHeight;
      };

      chatForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(chatForm);
        const res = await fetch("/chat", { method: "POST", body: formData });
        const data = await res.json();
        if (data.messages) {
          renderMessages(data.messages);
          chatInput.value = "";
        }
      });

      feedbackForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(feedbackForm);
        const res = await fetch("/feedback", { method: "POST", body: formData });
        const data = await res.json();
        feedbackStatus.textContent = data.ok ? "Thanks!" : "Error";
      });
    </script>
  </body>
</html>
